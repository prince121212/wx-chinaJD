# 微信小程序后端服务与管理后台开发计划

## 📋 项目概述

本项目旨在为现有的TDesign零售小程序构建完整的后端服务和管理后台，实现从Mock数据向真实数据库驱动的转型。基于现有小程序项目新加后端服务和管理后台。

### 🎯 项目目标
- 构建支持小程序所有功能的后端API服务
- 开发功能完善的管理后台系统
- 实现数据持久化和文件存储
- 提供高性能、高可用的生产环境部署

### 🔧 技术栈选择

#### 前端管理后台
- **Next.js 14**: 现代全栈框架，支持SSR/SSG，优秀的DX
- **TypeScript**: 类型安全，提升代码质量
- **Tailwind CSS**: 实用优先的CSS框架
- **Shadcn/ui**: 现代化的React组件库
- **React Hook Form + Zod**: 表单处理和验证

#### 后端服务
微信认证
- **Next.js API Routes**: 统一的全栈解决方案
- **Supabase**: BaaS平台，提供数据库、认证、实时订阅
- **Prisma**: 现代化的ORM工具
- **NextAuth.js**: 统一的认证解决方案

#### 文件存储
- **Cloudflare R2**: 成本效益最佳的对象存储
- **支持图片CDN优化**

#### 部署
- **Vercel**: 优化的Next.js部署平台

## 🏗️ 项目架构

### 整体架构图
```
微信小程序端 ←→ Next.js API Routes ←→ Supabase Database
                      ↕                    ↕
                管理后台界面            Cloudflare R2
                      ↕
                   NextAuth.js
```

### 目录结构规划
```
/backend-admin/
├── src/
│   ├── app/                    # App Router
│   │   ├── (dashboard)/       # 管理后台路由组
│   │   ├── api/               # API路由
│   │   │   ├── admin/         # 管理员API
│   │   │   ├── miniprogram/   # 小程序API
│   │   │   └── upload/        # 文件上传API
│   │   ├── auth/              # 认证页面
│   │   └── globals.css
│   ├── components/            # 共享组件
│   │   ├── ui/               # 基础UI组件
│   │   ├── forms/            # 表单组件
│   │   └── layouts/          # 布局组件
│   ├── lib/                  # 工具库
│   │   ├── database.ts       # 数据库连接
│   │   ├── auth.ts          # 认证配置
│   │   ├── upload.ts        # 文件上传
│   │   └── utils.ts         # 工具函数
│   ├── types/               # TypeScript类型定义
│   └── middleware.ts        # 中间件
├── prisma/
│   ├── schema.prisma        # 数据库模式
│   └── seed.ts             # 数据种子
├── public/
└── package.json
```

## 🗄️ 数据库设计

基于现有小程序的数据模型，设计以下主要表结构：

### 核心表结构

#### 用户表 (users)
```sql
- id (UUID, PK)
- openid (String, 微信openid)
- unionid (String, 微信unionid)
- nickname (String)
- avatar_url (String)
- phone (String)
- gender (Integer)
- created_at (DateTime)
- updated_at (DateTime)
```

#### 商品表 (products)
```sql
- id (UUID, PK)
- spu_id (String, 商品SPU)
- title (String, 商品标题)
- description (Text, 商品描述)
- category_id (UUID, FK)
- primary_image (String)
- images (JSON, 商品图片数组)
- status (Integer, 商品状态)
- sort_order (Integer)
- created_at (DateTime)
- updated_at (DateTime)
```

#### 商品SKU表 (product_skus)
```sql
- id (UUID, PK)
- sku_id (String, SKU编码)
- product_id (UUID, FK)
- price (Decimal, 价格)
- origin_price (Decimal, 原价)
- stock_quantity (Integer, 库存)
- spec_info (JSON, 规格信息)
- status (Integer)
- created_at (DateTime)
- updated_at (DateTime)
```

#### 分类表 (categories)
```sql
- id (UUID, PK)
- name (String)
- parent_id (UUID, FK)
- image (String)
- sort_order (Integer)
- status (Integer)
- created_at (DateTime)
- updated_at (DateTime)
```

#### 购物车表 (carts)
```sql
- id (UUID, PK)
- user_id (UUID, FK)
- sku_id (UUID, FK)
- quantity (Integer)
- selected (Boolean)
- created_at (DateTime)
- updated_at (DateTime)
```

#### 订单表 (orders)
```sql
- id (UUID, PK)
- order_no (String, 订单号)
- user_id (UUID, FK)
- status (Integer, 订单状态)
- total_amount (Decimal)
- discount_amount (Decimal)
- actual_amount (Decimal)
- address_info (JSON, 收货地址信息)
- remark (Text)
- created_at (DateTime)
- updated_at (DateTime)
```

#### 订单明细表 (order_items)
```sql
- id (UUID, PK)
- order_id (UUID, FK)
- sku_id (UUID, FK)
- quantity (Integer)
- price (Decimal)
- total_price (Decimal)
- spec_info (JSON)
- created_at (DateTime)
```

#### 地址表 (addresses)
```sql
- id (UUID, PK)
- user_id (UUID, FK)
- name (String, 收货人)
- phone (String)
- province (String)
- city (String)
- district (String)
- detail (String, 详细地址)
- is_default (Boolean)
- created_at (DateTime)
- updated_at (DateTime)
```

#### 优惠券表 (coupons)
```sql
- id (UUID, PK)
- title (String)
- description (Text)
- type (Integer, 优惠券类型)
- discount_value (Decimal)
- min_amount (Decimal, 最小使用金额)
- start_time (DateTime)
- end_time (DateTime)
- total_count (Integer, 总发放量)
- used_count (Integer, 已使用量)
- status (Integer)
- created_at (DateTime)
- updated_at (DateTime)
```

#### 用户优惠券表 (user_coupons)
```sql
- id (UUID, PK)
- user_id (UUID, FK)
- coupon_id (UUID, FK)
- status (Integer, 使用状态)
- used_at (DateTime)
- order_id (UUID, FK, nullable)
- created_at (DateTime)
```

## 🔌 API设计

### 小程序端API (/api/miniprogram/)

#### 用户模块
- `POST /api/miniprogram/auth/login` - 微信登录
- `GET /api/miniprogram/user/info` - 获取用户信息
- `PUT /api/miniprogram/user/info` - 更新用户信息

#### 商品模块
- `GET /api/miniprogram/products` - 商品列表
- `GET /api/miniprogram/products/[id]` - 商品详情
- `GET /api/miniprogram/categories` - 商品分类
- `GET /api/miniprogram/products/search` - 商品搜索

#### 购物车模块
- `GET /api/miniprogram/cart` - 获取购物车
- `POST /api/miniprogram/cart` - 添加到购物车
- `PUT /api/miniprogram/cart/[id]` - 更新购物车项
- `DELETE /api/miniprogram/cart/[id]` - 删除购物车项

#### 订单模块
- `POST /api/miniprogram/orders` - 创建订单
- `GET /api/miniprogram/orders` - 订单列表
- `GET /api/miniprogram/orders/[id]` - 订单详情
- `PUT /api/miniprogram/orders/[id]` - 更新订单状态

#### 地址模块
- `GET /api/miniprogram/addresses` - 地址列表
- `POST /api/miniprogram/addresses` - 新增地址
- `PUT /api/miniprogram/addresses/[id]` - 更新地址
- `DELETE /api/miniprogram/addresses/[id]` - 删除地址

### 管理后台API (/api/admin/)

#### 商品管理
- `GET /api/admin/products` - 商品列表（分页、筛选）
- `POST /api/admin/products` - 创建商品
- `PUT /api/admin/products/[id]` - 更新商品
- `DELETE /api/admin/products/[id]` - 删除商品

#### 订单管理
- `GET /api/admin/orders` - 订单列表
- `PUT /api/admin/orders/[id]/status` - 更新订单状态
- `GET /api/admin/orders/statistics` - 订单统计

#### 用户管理
- `GET /api/admin/users` - 用户列表
- `GET /api/admin/users/[id]` - 用户详情

#### 优惠券管理
- `GET /api/admin/coupons` - 优惠券列表
- `POST /api/admin/coupons` - 创建优惠券
- `PUT /api/admin/coupons/[id]` - 更新优惠券

## 🖥️ 管理后台功能规划

### 1. 仪表盘
- 销售概览（今日/本周/本月销售额）
- 订单统计图表
- 商品库存预警
- 用户增长趋势

### 2. 商品管理
- 商品列表（搜索、筛选、分页）
- 商品编辑（富文本编辑器、图片上传）
- 商品分类管理（树形结构）
- 库存管理
- 商品批量操作

### 3. 订单管理
- 订单列表（多状态筛选）
- 订单详情查看
- 订单状态管理
- 发货管理
- 退款处理

### 4. 用户管理
- 用户列表
- 用户详情查看
- 用户标签管理

### 5. 营销管理
- 优惠券创建和管理
- 营销活动配置
- 轮播图管理

### 6. 系统管理
- 管理员账户
- 系统配置
- 数据备份
- 操作日志

## 📅 开发阶段规划

### 阶段一：基础架构搭建 (1-2周)
1. **项目初始化**
   - 创建Next.js项目
   - 配置TypeScript、Tailwind CSS
   - 集成Shadcn/ui组件库
   
2. **数据库设计**
   - 设计Prisma Schema
   - 配置Supabase连接
   - 创建数据表结构
   - 编写数据种子文件

3. **认证系统**
   - 配置NextAuth.js
   - 实现管理员登录
   - 实现微信小程序授权

### 阶段二：核心API开发 (2-3周)
1. **用户模块API**
2. **商品模块API**
3. **购物车模块API**
4. **订单模块API**
5. **地址模块API**
6. **文件上传API（R2集成）**

### 阶段三：管理后台开发 (3-4周)
1. **基础布局和路由**
2. **仪表盘页面**
3. **商品管理页面**
4. **订单管理页面**
5. **用户管理页面**
6. **营销管理页面**

### 阶段四：小程序对接 (1-2周)
1. **替换Mock数据为真实API**
2. **功能测试和调试**
3. **性能优化**

### 阶段五：部署和优化 (1周)
1. **Vercel部署配置**
2. **环境变量配置**
3. **性能监控**
4. **安全加固**

## 🚀 部署方案

### 环境配置
- **开发环境**: 本地开发 + Supabase开发实例
- **生产环境**: Vercel + Supabase生产实例 + Cloudflare R2

### 环境变量
```bash
# 认证
管理后台无需认证，将会部署在https://china.wm985.top/

# 微信小程序
微信小程序的用户只需要使用微信登录即可 无需密码
WECHAT_APPID="wx640831368d15e774"
WECHAT_SECRET="f2240eb70ba9f6061979951d23e047bb"

# Cloudflare R2 存储配置
STORAGE_ENDPOINT = "https://674e70edb9c85b5003b036fbcd82bee8.r2.cloudflarestorage.com"
STORAGE_REGION = "auto"
STORAGE_ACCESS_KEY = "45df78fdcb100fd68ffedc7518dbc3d4"
STORAGE_SECRET_KEY = "96231c12f68958d02dc06ac775d94cf3697d30c141bdc0094cea6f000b5ebfca"
STORAGE_BUCKET = "hcw"
STORAGE_PUBLIC_URL = "https://pub-7d345f4cf2334fce864509d66ec976f3.r2.dev"


# 数据库
# Supabase
NEXT_PUBLIC_SUPABASE_URL="https://zhlxqqtahpamntbdtbmf.supabase.co"
NEXT_PUBLIC_SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpobHhxcXRhaHBhbW50YmR0Ym1mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5NjM2MzksImV4cCI6MjA3MTUzOTYzOX0.TtLbRbreNB9L93Al-CZymhZ2uDZJHKw1s2lux_PcIcc"
SUPABASE_SERVICE_ROLE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpobHhxcXRhaHBhbW50YmR0Ym1mIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NTk2MzYzOSwiZXhwIjoyMDcxNTM5NjM5fQ.aH8gH_RCnOhds7dKBS-IYvzSqhWjxyuhQXERfwuPHjc"
```
Set-Location backend; npx prisma studio

### 部署步骤
1. 在本仓库的根目录新建文件夹backend作为后端服务和管理后台的文件夹
2. 配置环境变量

## 🔒 安全考虑

1. **API安全**
   - JWT Token认证
   - Rate Limiting
   - CORS配置
   - 输入验证和SQL注入防护

2. **数据安全**
   - 访问日志记录

3. **文件安全**
   - 文件类型限制
   - 文件大小限制

## 📊 监控和维护

1. **性能监控**
   - Vercel Analytics
   - API响应时间监控
   - 数据库性能监控

2. **错误监控**
   - 错误日志收集

## 🎯 后续扩展计划

1. **功能扩展**
   - 多商户支持
   - 数据分析系统

2. **技术升级**
   - CDN优化
   - 缓存策略

---

## ✅ 总结

此开发计划涵盖了从架构设计到部署维护的完整流程，采用现代化的技术栈确保项目的可维护性和扩展性。
仔细核对前后端接口字段，务必一次跑通项目。